<!-- templates/sao/working_hours_list.html -->
{% extends "base.html" %}
{% load widget_tweaks %}

{% block header %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mt-3">
        <div class="col">
            <h4>å‹¤å‹™æ™‚é–“è¨­å®š</h4>
        </div>
        <div class="col">
            <div class="float-end">
                <a href="#" class="btn btn-info" id="add-btn">å‹¤å‹™æ™‚é–“ã‚’è¿½åŠ ã™ã‚‹</a>
            </div>
        </div>
    </div>

    <table class="table table-striped table-bordered mt-3">
        <thead>
            <tr>
                <th>åŒºåˆ†</th>
                <th>å‡ºç¤¾æ™‚é–“</th>
                <th>é€€ç¤¾æ™‚é–“</th>
                <th>æœ‰åŠ¹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for w in working_hours %}
            <tr>
                <td>{{w.category}}</td>
                <td>{{w.begin_time}}</td>
                <td>{{w.end_time}}</td>
                <td>
                    {% if w.is_active %}
                        <span class="badge bg-success">æœ‰åŠ¹</span>
                    {% else %}
                        <span class="badge bg-secondary">ç„¡åŠ¹</span>
                    {% endif %}
                </td>
                <td>
                    <!-- ğŸ”¥ ç·¨é›†ãƒœã‚¿ãƒ³ -->
                    <button type="button" 
                            class="btn btn-sm btn-primary edit-btn" 
                            data-id="{{ w.id }}"
                            data-category="{{ w.category }}"
                            data-begin-time="{{ w.begin_time|time:'H:i' }}"
                            data-end-time="{{ w.end_time|time:'H:i' }}"
                            data-is-active="{{ w.is_active|yesno:'true,false' }}"
                            data-url="{% url 'sao:edit_working_hours' w.id %}">
                        <i class="bi bi-pencil"></i> ç·¨é›†
                    </button>
                    
                    <a href="{% url 'sao:del_working_hours' w.id %}" 
                       class="btn btn-sm btn-danger" 
                       title="å‰Šé™¤"
                       onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                        <i class="bi bi-trash"></i> å‰Šé™¤
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ -->
{% include 'sao/edit_working_hours_modal.html' %}
{% include 'sao/add_working_hours_modal.html' %}

<script>
console.log('ğŸ• Working Hours List - Script loaded');

// æ±ç”¨çš„ãªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
function setupModal({
    buttonSelector,
    modalSelector,
    formSelector,
    fields,
    getData,
    setTitle,
    validate
}) {
    const buttons = document.querySelectorAll(buttonSelector);
    const modal = document.getElementById(modalSelector);
    if (!modal) return;

    let modalInstance = new bootstrap.Modal(modal);

    buttons.forEach(function(button) {
        button.addEventListener('click', function() {
            const data = getData(button);

            // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            fields.forEach(f => {
                const el = document.getElementById(f.id);
                if (el) el.value = data[f.key];
                if (f.type === 'checkbox' && el) el.checked = !!data[f.key];
            });

            // ãƒ•ã‚©ãƒ¼ãƒ action
            const form = document.getElementById(formSelector);
            if (form && data.action) form.action = data.action;

            // ã‚¿ã‚¤ãƒˆãƒ«
            if (setTitle) setTitle(data);

            modalInstance.show();
        });
    });

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const form = document.getElementById(formSelector);
    if (form && validate) {
        form.addEventListener('submit', function(e) {
            if (!validate()) {
                e.preventDefault();
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ• DOM Content Loaded');
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupModal({
        buttonSelector: '.edit-btn',
        modalSelector: 'editModal',
        formSelector: 'editForm',
        fields: [
            {id: 'edit_category', key: 'category'},
            {id: 'edit_begin_time', key: 'beginTime'},
            {id: 'edit_end_time', key: 'endTime'},
            {id: 'edit_is_active', key: 'isActive', type: 'checkbox'}
        ],
        getData: (btn) => ({
            category: btn.getAttribute('data-category'),
            beginTime: btn.getAttribute('data-begin-time'),
            endTime: btn.getAttribute('data-end-time'),
            isActive: btn.getAttribute('data-is-active') === 'true',
            action: btn.getAttribute('data-url')
        }),
        validate: () => {
            const begin = document.getElementById('edit_begin_time').value;
            const end = document.getElementById('edit_end_time').value;
            if (begin >= end) {
                alert('âš ï¸ å‡ºç¤¾æ™‚é–“ã¯é€€ç¤¾æ™‚é–“ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                return false;
            }
            return true;
        }
    });

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupModal({
        buttonSelector: '#add-btn',
        modalSelector: 'addModal',
        formSelector: 'addForm',
        fields: [
            {id: 'add_category', key: 'category'},
            {id: 'add_begin_time', key: 'beginTime'},
            {id: 'add_end_time', key: 'endTime'},
            {id: 'add_is_active', key: 'isActive', type: 'checkbox'}
        ],
        getData: () => ({
            category: '',
            beginTime: '',
            endTime: '',
            isActive: true,
            action: document.getElementById('addForm').getAttribute('action')
        }),
        setTitle: () => {
            const label = document.getElementById('addModalLabel');
            if (label) label.textContent = 'ğŸ• å‹¤å‹™æ™‚é–“ã®è¿½åŠ ';
        },
        validate: () => {
            const begin = document.getElementById('add_begin_time').value;
            const end = document.getElementById('add_end_time').value;
            if (begin >= end) {
                alert('âš ï¸ å‡ºç¤¾æ™‚é–“ã¯é€€ç¤¾æ™‚é–“ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                return false;
            }
            return true;
        }
    });
});
</script>

{% endblock %}

{% block footer %}
{% endblock %}