<!-- templates/sao/working_hours_list.html -->
{% extends "base.html" %}
{% load widget_tweaks %}

{% block header %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mt-3">
        <div class="col">
            <h4>å‹¤å‹™æ™‚é–“è¨­å®š</h4>
        </div>
        <div class="col">
            <div class="float-end">
                <a href={% url 'sao:add_working_hours' %} class="btn btn-info">å‹¤å‹™æ™‚é–“ã‚’è¿½åŠ ã™ã‚‹</a>
            </div>
        </div>
    </div>

    <table class="table table-striped table-bordered mt-3">
        <thead>
            <tr>
                <th>åŒºåˆ†</th>
                <th>å‡ºç¤¾æ™‚é–“</th>
                <th>é€€ç¤¾æ™‚é–“</th>
                <th>æœ‰åŠ¹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for w in working_hours %}
            <tr>
                <td>{{w.category}}</td>
                <td>{{w.begin_time}}</td>
                <td>{{w.end_time}}</td>
                <td>
                    {% if w.is_active %}
                        <span class="badge bg-success">æœ‰åŠ¹</span>
                    {% else %}
                        <span class="badge bg-secondary">ç„¡åŠ¹</span>
                    {% endif %}
                </td>
                <td>
                    <!-- ğŸ”¥ ç·¨é›†ãƒœã‚¿ãƒ³ -->
                    <button type="button" 
                            class="btn btn-sm btn-primary edit-btn" 
                            data-id="{{ w.id }}"
                            data-category="{{ w.category }}"
                            data-begin-time="{{ w.begin_time|time:'H:i' }}"
                            data-end-time="{{ w.end_time|time:'H:i' }}"
                            data-is-active="{{ w.is_active|yesno:'true,false' }}"
                            data-url="{% url 'sao:edit_working_hours' w.id %}">
                        <i class="bi bi-pencil"></i> ç·¨é›†
                    </button>
                    
                    <a href="{% url 'sao:del_working_hours' w.id %}" 
                       class="btn btn-sm btn-danger" 
                       title="å‰Šé™¤"
                       onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                        <i class="bi bi-trash"></i> å‰Šé™¤
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ -->
{% include 'sao/edit_working_hours_modal.html' %}

<script>
console.log('ğŸ• Working Hours List - Script loaded');

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ• DOM Content Loaded');
    
    // è¦ç´ ã®å­˜åœ¨ç¢ºèª
    const editButtons = document.querySelectorAll('.edit-btn');
    const editModal = document.getElementById('editModal');
    
    console.log('Edit buttons found:', editButtons.length);
    console.log('Edit modal found:', !!editModal);
    
    if (!editModal) {
        console.error('âŒ Edit modal not found!');
        return;
    }
    
    // Bootstrap Modal ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    let modalInstance;
    try {
        modalInstance = new bootstrap.Modal(editModal);
        console.log('âœ… Modal instance created');
    } catch (error) {
        console.error('âŒ Failed to create modal instance:', error);
        return;
    }
    
    // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    editButtons.forEach(function(button, index) {
        button.addEventListener('click', function() {
            const data = {
                id: this.getAttribute('data-id'),
                category: this.getAttribute('data-category'),
                beginTime: this.getAttribute('data-begin-time'),
                endTime: this.getAttribute('data-end-time'),
                isActive: this.getAttribute('data-is-active') === 'true',
                url: this.getAttribute('data-url')
            };
            
            console.log('ğŸ• Edit button clicked:', data);
            
            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’å–å¾—
            const form = document.getElementById('editForm');
            const categoryInput = document.getElementById('edit_category');
            const beginTimeInput = document.getElementById('edit_begin_time');
            const endTimeInput = document.getElementById('edit_end_time');
            const isActiveInput = document.getElementById('edit_is_active');
            const modalLabel = document.getElementById('editModalLabel');
            
            // è¦ç´ ã®å­˜åœ¨ç¢ºèª
            if (!form || !categoryInput || !beginTimeInput || !endTimeInput || !isActiveInput) {
                console.error('âŒ Form elements not found');
                alert('ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            categoryInput.value = data.category;
            beginTimeInput.value = data.beginTime;
            endTimeInput.value = data.endTime;
            isActiveInput.checked = data.isActive;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã®action URLã‚’è¨­å®š
            form.action = data.url;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            if (modalLabel) {
                modalLabel.textContent = `ğŸ• ã€Œ${data.category}ã€ã®ç·¨é›†`;
            }
            
            console.log('âœ… Form populated with data');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            try {
                modalInstance.show();
                console.log('âœ… Modal shown');
            } catch (error) {
                console.error('âŒ Failed to show modal:', error);
                alert('ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            const beginTime = document.getElementById('edit_begin_time').value;
            const endTime = document.getElementById('edit_end_time').value;
            
            console.log('ğŸ• Form validation:', { beginTime, endTime });
            
            // æ™‚é–“ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            if (beginTime >= endTime) {
                e.preventDefault();
                alert('âš ï¸ å‡ºç¤¾æ™‚é–“ã¯é€€ç¤¾æ™‚é–“ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                console.log('âŒ Validation failed: Invalid time range');
                return false;
            }
            
            console.log('âœ… Form validation passed');
        });
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    editModal.addEventListener('shown.bs.modal', function() {
        console.log('ğŸ• Modal shown - focusing first input');
        const firstInput = document.getElementById('edit_category');
        if (firstInput) {
            firstInput.focus();
        }
    });
    
    editModal.addEventListener('hidden.bs.modal', function() {
        console.log('ğŸ• Modal hidden');
    });
});
</script>

{% endblock %}

{% block footer %}
{% endblock %}